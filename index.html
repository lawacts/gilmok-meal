<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ëª©êµíšŒ 2026ë…„ ì£¼ì¼ì‹ì‚¬ ì„¬ê¹€</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .month-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .month-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .month-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .month-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .month-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .month-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .weeks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .week-card {
            background: #f8f9ff;
            border-radius: 16px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .week-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
            transform: translateY(-3px);
        }

        .week-card.has-servant {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border-color: #4caf50;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .week-info h3 {
            font-size: 1.1rem;
            color: #333;
            font-weight: 700;
        }

        .week-date {
            font-size: 0.85rem;
            color: #888;
            margin-top: 3px;
        }

        .week-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .birthdays {
            background: #fff3e0;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 15px;
            border-left: 3px solid #ff9800;
        }

        .birthdays-label {
            font-size: 0.7rem;
            color: #e65100;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .birthdays-list {
            font-size: 0.75rem;
            color: #666;
            line-height: 1.6;
        }

        .birthday-item {
            display: inline;
        }

        .birthday-item::after {
            content: ', ';
        }

        .birthday-item:last-child::after {
            content: '';
        }

        .lunar-tag {
            color: #9c27b0;
            font-weight: 600;
        }

        .solar-convert {
            color: #1976d2;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .method-select {
            display: flex;
            gap: 10px;
        }

        .method-option {
            flex: 1;
            position: relative;
        }

        .method-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .method-label {
            display: block;
            padding: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .method-option input:checked + .method-label {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .method-label:hover {
            border-color: #667eea;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        .save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .servant-display {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .servant-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .servant-method {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .servant-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .edit-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: #4caf50;
            border: 2px solid #4caf50;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .edit-btn:hover {
            background: #4caf50;
            color: white;
        }

        .summary {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .summary h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa, #e4e8f0);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #e53935;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .month-section {
                padding: 20px;
            }

            .weeks-grid {
                grid-template-columns: 1fr;
            }

            .month-btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸš ê¸¸ëª©êµíšŒ ì£¼ì¼ì‹ì‚¬ ì„¬ê¹€</h1>
            <p>2026ë…„ 52ì£¼ ì‹ì‚¬ ì„¬ê¹€ ì¼ì • ë“±ë¡</p>
            <div class="sync-status">
                <div class="sync-dot"></div>
                <span>ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘</span>
            </div>
        </header>

        <div class="summary">
            <h2>ğŸ“Š ì„¬ê¹€ í˜„í™©</h2>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalWeeks">52</div>
                    <div class="stat-label">ì „ì²´ ì£¼ì¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="filledWeeks">0</div>
                    <div class="stat-label">ë“±ë¡ ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="remainingWeeks">52</div>
                    <div class="stat-label">ë‚¨ì€ ì£¼ì¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selfPrepare">0</div>
                    <div class="stat-label">ë³¸ì¸ì¤€ë¹„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="churchPrepare">0</div>
                    <div class="stat-label">êµíšŒì¤€ë¹„</div>
                </div>
            </div>
        </div>

        <nav class="month-nav">
            <button class="month-btn active" onclick="scrollToMonth(1)">1ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(2)">2ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(3)">3ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(4)">4ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(5)">5ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(6)">6ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(7)">7ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(8)">8ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(9)">9ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(10)">10ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(11)">11ì›”</button>
            <button class="month-btn" onclick="scrollToMonth(12)">12ì›”</button>
        </nav>

        <div id="calendar"></div>
    </div>

    <div class="toast" id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyA1899QZwBAgLmi2fU1QzR5cVVYWpDlpvo",
            authDomain: "gilmok-meal.firebaseapp.com",
            projectId: "gilmok-meal",
            storageBucket: "gilmok-meal.firebasestorage.app",
            messagingSenderId: "761772428630",
            appId: "1:761772428630:web:e1afaebb343dfea2381af7"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Google Sheets ì›¹ì•± URL (ë‚˜ì¤‘ì— ì„¤ì •)
        const GOOGLE_SHEETS_WEBHOOK = null; // Google Apps Script ë°°í¬ í›„ URL ì…ë ¥

        // 2026ë…„ ì£¼ì¼ ë°ì´í„°
        const sundaysData = [
            { week: 1, date: "2026-01-04", month: 1, day: 4, birthdays: [{ name: "ì²œí˜¸ë¦¼", birthday: "1/4" }] },
            { week: 2, date: "2026-01-11", month: 1, day: 11, birthdays: [{ name: "ì´ê·œì—°", birthday: "1/10" }] },
            { week: 3, date: "2026-01-18", month: 1, day: 18, birthdays: [{ name: "ì œìœ¤ì„œ", birthday: "1/16" }, { name: "ê¹€í™í˜„", birthday: "1/17" }, { name: "ì¶”ë‚˜ë¼", birthday: "1/18" }] },
            { week: 4, date: "2026-01-25", month: 1, day: 25, birthdays: [] },
            { week: 5, date: "2026-02-01", month: 2, day: 1, birthdays: [] },
            { week: 6, date: "2026-02-08", month: 2, day: 8, birthdays: [{ name: "ê³ ì€í˜¸", birthday: "2/5" }] },
            { week: 7, date: "2026-02-15", month: 2, day: 15, birthdays: [{ name: "ì¡°ì„±ì°¬", birthday: "2/10" }, { name: "ì¥í˜„ì£¼", birthday: "2/12" }, { name: "ìµœê²½í˜œ", birthday: "2/12" }, { name: "ì •ì§€í˜œ", birthday: "2/13" }, { name: "ì‹ ì°½ë¬´", birthday: "2/13" }] },
            { week: 8, date: "2026-02-22", month: 2, day: 22, birthdays: [{ name: "ì´ë¦°ìš°", birthday: "2/17" }] },
            { week: 9, date: "2026-03-01", month: 3, day: 1, birthdays: [{ name: "ì´ì˜ˆë¦¼", birthday: "2/25" }] },
            { week: 10, date: "2026-03-08", month: 3, day: 8, birthdays: [{ name: "ê¹€ì§„ì•„", birthday: "3/3" }, { name: "ê¹€ê³ ì€", birthday: "3/5" }] },
            { week: 11, date: "2026-03-15", month: 3, day: 15, birthdays: [{ name: "ê¶Œì¢…ì‹ ", birthday: "ìŒ 1/23, ì–‘ 3/11" }] },
            { week: 12, date: "2026-03-22", month: 3, day: 22, birthdays: [{ name: "ì´ì¢…ì§„", birthday: "3/22" }] },
            { week: 13, date: "2026-03-29", month: 3, day: 29, birthdays: [{ name: "ì‹ íš¨ì§„", birthday: "3/26" }, { name: "ì‹¬ë§ˆë¦¬ì•„", birthday: "3/27" }] },
            { week: 14, date: "2026-04-05", month: 4, day: 5, birthdays: [{ name: "ì²œì„ ì˜", birthday: "3/31" }] },
            { week: 15, date: "2026-04-12", month: 4, day: 12, birthdays: [{ name: "ì˜¤ê°€íƒ€ ë§ˆìœ ", birthday: "4/6" }, { name: "ê¹€ë‚˜í˜œ", birthday: "4/12" }] },
            { week: 16, date: "2026-04-19", month: 4, day: 19, birthdays: [{ name: "ê¹€ì†Œìœ¤", birthday: "4/16" }, { name: "ì´ìˆ˜ì§„", birthday: "4/17" }, { name: "ì´ê¸¸ì£¼", birthday: "ìŒ 3/3, ì–‘ 4/19" }] },
            { week: 17, date: "2026-04-26", month: 4, day: 26, birthdays: [] },
            { week: 18, date: "2026-05-03", month: 5, day: 3, birthdays: [] },
            { week: 19, date: "2026-05-10", month: 5, day: 10, birthdays: [] },
            { week: 20, date: "2026-05-17", month: 5, day: 17, birthdays: [] },
            { week: 21, date: "2026-05-24", month: 5, day: 24, birthdays: [{ name: "ì‹ í¬ì§„", birthday: "5/19" }, { name: "ê¹€í•˜ìœ¤", birthday: "5/22" }] },
            { week: 22, date: "2026-05-31", month: 5, day: 31, birthdays: [{ name: "ê¹€ìƒì§„", birthday: "5/31" }] },
            { week: 23, date: "2026-06-07", month: 6, day: 7, birthdays: [] },
            { week: 24, date: "2026-06-14", month: 6, day: 14, birthdays: [{ name: "ìœ ì†Œí˜„", birthday: "6/9" }, { name: "ê¹€ì§€ì˜", birthday: "6/13" }] },
            { week: 25, date: "2026-06-21", month: 6, day: 21, birthdays: [{ name: "ì²œí•˜ìœ¨", birthday: "6/15" }, { name: "ì´ì¶˜ì›", birthday: "6/17" }] },
            { week: 26, date: "2026-06-28", month: 6, day: 28, birthdays: [{ name: "ì¥ì²œ", birthday: "6/24" }, { name: "ì²œì‚¬ë‘", birthday: "6/27" }] },
            { week: 27, date: "2026-07-05", month: 7, day: 5, birthdays: [{ name: "ì´ì±„ìš°", birthday: "6/30" }] },
            { week: 28, date: "2026-07-12", month: 7, day: 12, birthdays: [] },
            { week: 29, date: "2026-07-19", month: 7, day: 19, birthdays: [{ name: "ì´ê±´ëª…", birthday: "7/17" }] },
            { week: 30, date: "2026-07-26", month: 7, day: 26, birthdays: [] },
            { week: 31, date: "2026-08-02", month: 8, day: 2, birthdays: [{ name: "ì¶”í•˜ëŠ˜", birthday: "7/29" }, { name: "ì—¬ì„±ì€", birthday: "7/30" }] },
            { week: 32, date: "2026-08-09", month: 8, day: 9, birthdays: [] },
            { week: 33, date: "2026-08-16", month: 8, day: 16, birthdays: [] },
            { week: 34, date: "2026-08-23", month: 8, day: 23, birthdays: [{ name: "ê¹€ì§€ì˜", birthday: "ìŒ 7/10, ì–‘ 8/22" }] },
            { week: 35, date: "2026-08-30", month: 8, day: 30, birthdays: [{ name: "ì œì˜ì„œ", birthday: "8/24" }, { name: "ì „ì •ë¯¼", birthday: "8/26" }, { name: "ì¡°ì„±ê¶Œ", birthday: "8/29" }] },
            { week: 36, date: "2026-09-06", month: 9, day: 6, birthdays: [] },
            { week: 37, date: "2026-09-13", month: 9, day: 13, birthdays: [] },
            { week: 38, date: "2026-09-20", month: 9, day: 20, birthdays: [{ name: "ì´ì„±ë™", birthday: "9/17" }] },
            { week: 39, date: "2026-09-27", month: 9, day: 27, birthdays: [] },
            { week: 40, date: "2026-10-04", month: 10, day: 4, birthdays: [] },
            { week: 41, date: "2026-10-11", month: 10, day: 11, birthdays: [{ name: "ë°•ì‚¬ë¬´ì—˜", birthday: "10/5" }, { name: "ì¶”ë¯¸ìœ í‚¤", birthday: "10/11" }] },
            { week: 42, date: "2026-10-18", month: 10, day: 18, birthdays: [{ name: "ì•ˆì„±ì§„", birthday: "10/15" }, { name: "ì—„ë‹¤ë‚˜", birthday: "10/15" }] },
            { week: 43, date: "2026-10-25", month: 10, day: 25, birthdays: [{ name: "ê¹€ë‹¤ìœ¤", birthday: "10/22" }] },
            { week: 44, date: "2026-11-01", month: 11, day: 1, birthdays: [] },
            { week: 45, date: "2026-11-08", month: 11, day: 8, birthdays: [] },
            { week: 46, date: "2026-11-15", month: 11, day: 15, birthdays: [] },
            { week: 47, date: "2026-11-22", month: 11, day: 22, birthdays: [{ name: "ê¹€í˜„ì •", birthday: "11/19" }, { name: "ì´ì§„í˜•", birthday: "11/22" }] },
            { week: 48, date: "2026-11-29", month: 11, day: 29, birthdays: [{ name: "ì´ë„ì—°", birthday: "11/24" }, { name: "ê¹€íƒœí˜„", birthday: "11/27" }] },
            { week: 49, date: "2026-12-06", month: 12, day: 6, birthdays: [{ name: "ì¶”ëŒ€ì‹", birthday: "12/1" }] },
            { week: 50, date: "2026-12-13", month: 12, day: 13, birthdays: [{ name: "ê¹€ì ìˆœ", birthday: "ìŒ 11/3, ì–‘ 12/11" }] },
            { week: 51, date: "2026-12-20", month: 12, day: 20, birthdays: [] },
            { week: 52, date: "2026-12-27", month: 12, day: 27, birthdays: [] }
        ];

        const monthNames = ['', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

        // ì„¬ê¹€ ë°ì´í„° (Firebaseì—ì„œ ë¡œë“œ)
        let servantData = {};

        // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupRealtimeListener() {
            db.collection('servants').onSnapshot((snapshot) => {
                servantData = {};
                snapshot.forEach((doc) => {
                    servantData[doc.id] = doc.data();
                });
                renderCalendar();
                hideLoading();
            }, (error) => {
                console.error("Firebase ì—ëŸ¬:", error);
                showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', true);
                hideLoading();
            });
        }

        // Google Sheetsì— ë™ê¸°í™”
        async function syncToGoogleSheets(week, data) {
            if (!GOOGLE_SHEETS_WEBHOOK) return;
            
            try {
                const sunday = sundaysData.find(s => s.week === parseInt(week));
                await fetch(GOOGLE_SHEETS_WEBHOOK, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week: week,
                        date: sunday.date,
                        name: data.name,
                        method: data.method === 'self' ? 'ë³¸ì¸ì¤€ë¹„' : 'êµíšŒì¤€ë¹„',
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Google Sheets ë™ê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';

            const monthGroups = {};
            sundaysData.forEach(sunday => {
                if (!monthGroups[sunday.month]) {
                    monthGroups[sunday.month] = [];
                }
                monthGroups[sunday.month].push(sunday);
            });

            Object.keys(monthGroups).forEach(month => {
                const section = document.createElement('div');
                section.className = 'month-section';
                section.id = `month-${month}`;

                const monthIcon = ['ğŸŒ¸', 'â„ï¸', 'ğŸŒ·', 'ğŸŒ¼', 'ğŸŒº', 'â˜€ï¸', 'ğŸŒ»', 'ğŸŒ´', 'ğŸ‚', 'ğŸƒ', 'ğŸ', 'ğŸ„'][month - 1];

                section.innerHTML = `
                    <h2 class="month-title">
                        <span class="month-icon">${monthIcon}</span>
                        ${monthNames[month]}
                    </h2>
                    <div class="weeks-grid" id="weeks-${month}"></div>
                `;

                container.appendChild(section);

                const weeksGrid = section.querySelector(`#weeks-${month}`);
                monthGroups[month].forEach(sunday => {
                    weeksGrid.appendChild(createWeekCard(sunday));
                });
            });

            updateStats();
        }

        function formatBirthday(birthday) {
            if (birthday.startsWith('ìŒ ')) {
                const parts = birthday.split(', ');
                const lunar = parts[0];
                const solar = parts[1];
                return `<span class="lunar-tag">${lunar}</span>, <span class="solar-convert">${solar}</span>`;
            }
            return birthday;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} ë“±ë¡`;
        }

        function createWeekCard(sunday) {
            const card = document.createElement('div');
            card.className = 'week-card';
            card.id = `week-${sunday.week}`;

            const saved = servantData[String(sunday.week)];
            if (saved) {
                card.classList.add('has-servant');
            }

            const birthdayHTML = sunday.birthdays.length > 0 ? `
                <div class="birthdays">
                    <div class="birthdays-label">ğŸ‚ ì´ë²ˆ ì£¼ ìƒì¼</div>
                    <div class="birthdays-list">
                        ${sunday.birthdays.map(b => `<span class="birthday-item">${b.name}(${formatBirthday(b.birthday)})</span>`).join('')}
                    </div>
                </div>
            ` : '';

            if (saved) {
                card.innerHTML = `
                    <div class="week-header">
                        <div class="week-info">
                            <h3>${sunday.month}ì›” ${sunday.day}ì¼ ì£¼ì¼</h3>
                            <div class="week-date">${sunday.date}</div>
                        </div>
                        <span class="week-number">${sunday.week}ì£¼</span>
                    </div>
                    ${birthdayHTML}
                    <div class="servant-display">
                        <div class="servant-name">ğŸ‘¤ ${saved.name}</div>
                        <div class="servant-method">${saved.method === 'self' ? 'ğŸ“¦ ë³¸ì¸ì¤€ë¹„' : 'ğŸ  êµíšŒì—ì„œì¤€ë¹„'}</div>
                        <div class="servant-time">${formatTimestamp(saved.timestamp)}</div>
                    </div>
                    <button class="edit-btn" onclick="editServant(${sunday.week})">ìˆ˜ì •í•˜ê¸°</button>
                `;
            } else {
                card.innerHTML = `
                    <div class="week-header">
                        <div class="week-info">
                            <h3>${sunday.month}ì›” ${sunday.day}ì¼ ì£¼ì¼</h3>
                            <div class="week-date">${sunday.date}</div>
                        </div>
                        <span class="week-number">${sunday.week}ì£¼</span>
                    </div>
                    ${birthdayHTML}
                    <div class="form-group">
                        <label>ì„¬ê¸°ëŠ” ë¶„ ì´ë¦„</label>
                        <input type="text" id="name-${sunday.week}" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ì„¬ê¹€ ë°©ë²•</label>
                        <div class="method-select">
                            <div class="method-option">
                                <input type="radio" name="method-${sunday.week}" id="self-${sunday.week}" value="self">
                                <label class="method-label" for="self-${sunday.week}">ğŸ“¦ ë³¸ì¸ì¤€ë¹„</label>
                            </div>
                            <div class="method-option">
                                <input type="radio" name="method-${sunday.week}" id="church-${sunday.week}" value="church">
                                <label class="method-label" for="church-${sunday.week}">ğŸ  êµíšŒì¤€ë¹„</label>
                            </div>
                        </div>
                    </div>
                    <button class="save-btn" onclick="saveServant(${sunday.week})">ë“±ë¡í•˜ê¸°</button>
                `;
            }

            return card;
        }

        async function saveServant(week) {
            const nameInput = document.getElementById(`name-${week}`);
            const name = nameInput.value.trim();
            
            const selfRadio = document.getElementById(`self-${week}`);
            const churchRadio = document.getElementById(`church-${week}`);
            
            if (!name) {
                showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', true);
                nameInput.focus();
                return;
            }

            if (!selfRadio.checked && !churchRadio.checked) {
                showToast('ì„¬ê¹€ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', true);
                return;
            }

            const method = selfRadio.checked ? 'self' : 'church';
            const data = { 
                name, 
                method, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            };

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const btn = document.querySelector(`#week-${week} .save-btn`);
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                await db.collection('servants').doc(String(week)).set(data);
                await syncToGoogleSheets(week, data);
                showToast('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ™');
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showToast('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true);
                btn.disabled = false;
                btn.textContent = 'ë“±ë¡í•˜ê¸°';
            }
        }

        async function editServant(week) {
            if (!confirm('ì •ë§ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('servants').doc(String(week)).delete();
                showToast('ìˆ˜ì • ëª¨ë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        function updateStats() {
            const filled = Object.keys(servantData).length;
            const selfCount = Object.values(servantData).filter(s => s.method === 'self').length;
            const churchCount = Object.values(servantData).filter(s => s.method === 'church').length;

            document.getElementById('filledWeeks').textContent = filled;
            document.getElementById('remainingWeeks').textContent = 52 - filled;
            document.getElementById('selfPrepare').textContent = selfCount;
            document.getElementById('churchPrepare').textContent = churchCount;
        }

        function scrollToMonth(month) {
            const element = document.getElementById(`month-${month}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            document.querySelectorAll('.month-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === month);
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ìŠ¤í¬ë¡¤ ì‹œ ì›” ë²„íŠ¼ í™œì„±í™”
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('.month-section');
            let currentMonth = 1;

            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 200) {
                    currentMonth = parseInt(section.id.split('-')[1]);
                }
            });

            document.querySelectorAll('.month-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === currentMonth);
            });
        });

        // ì´ˆê¸°í™”
        setupRealtimeListener();
    </script>
</body>
</html>
